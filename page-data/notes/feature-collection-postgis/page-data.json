{"componentChunkName":"component---src-templates-blog-post-js","path":"/notes/feature-collection-postgis","result":{"data":{"markdownRemark":{"html":"<p>Generating a Feature and Feature Collection form postgis is rather simple. If you convert a simple <a href=\"https://postgis.net/docs/geometry.html\">GEOMETRY</a> with the <a href=\"https://postgis.net/docs/ST_AsGeoJSON.html\"><code class=\"language-text\">st_asgeojson</code></a> postgis will generate a GeoJSON \"geometry\".</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> st_asgeojson<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span><span class=\"token keyword\">geometry</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> field f<span class=\"token punctuation\">;</span></code></pre></div>\n<p>will result in a single geometry:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Polygon\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"coordinates\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>...<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>If you provide a <strong>RECORD</strong> (since Postgis 3.0.0), postgis will generate a Feature with all the fields as Properties:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> st_asgeojson<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">FROM</span> field f<span class=\"token punctuation\">;</span></code></pre></div>\n<p>will result in:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Feature\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"geometry\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Polygon\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"coordinates\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      ...\n    <span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"052ff36a-4ea7-4307-9bc3-414f49a62163\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"area_square_meters\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">29434</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"altitude\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">40</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"granule_code\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"31UGT\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"creation_date\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"2021-10-21T23:32:25.974059\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"name\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Simple test field\"</span><span class=\"token punctuation\">,</span>\n    ...\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Where the field table having the Columns: <code class=\"language-text\">id</code>, <code class=\"language-text\">area_square_meters</code>, ...</p>\n<p>This comes in rather handy, if you, e.g. like to export a Feature Collection by some grouping column. Let's say, we have a <code class=\"language-text\">farm_id</code>, where all the fields reference to as the owner of the field.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> JSON_BUILD_OBJECT<span class=\"token punctuation\">(</span>\n               <span class=\"token string\">'type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'FeatureCollection'</span><span class=\"token punctuation\">,</span>\n               <span class=\"token string\">'features'</span><span class=\"token punctuation\">,</span> JSON_AGG<span class=\"token punctuation\">(</span>st_asgeojson<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>::JSONB<span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> feature_collection\n<span class=\"token keyword\">FROM</span> field f\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> farm_id<span class=\"token punctuation\">;</span></code></pre></div>\n<p>We have to build the actual root node <code class=\"language-text\">FeatureCollectio</code> by ourselves and just <code class=\"language-text\">JSON_AGG</code> the specific Features / Geometries of the farm.</p>\n<p>This Results in a nice Feature Collection:</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"FeatureCollection\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"features\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Feature\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"geometry\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Polygon\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"coordinates\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          ...\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"9836ef53-16bd-40d8-bc4c-d2d9d152c167\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"area_square_meters\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">215311</span><span class=\"token punctuation\">,</span>\n        ...\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Feature\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"geometry\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"type\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"Polygon\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"coordinates\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          ...\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"properties\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"id\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"ebdec7b2-204f-453b-b59b-f8eacccf2c44\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"area_square_meters\"</span> <span class=\"token operator\">:</span> <span class=\"token number\">48207</span><span class=\"token punctuation\">,</span>\n        ...\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The Resulting Feature Collection can then easily be pasted into e.g. <a href=\"https://geojson.io/\">https://geojson.io/</a> where you can have a look at the farms features on a map.</p>\n<p>By default, <code class=\"language-text\">st_asgeojson</code> will append all the Field Columns as properties of the Feature. You can of course reduce the Properties by just selecting the relevant Columns:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> JSON_BUILD_OBJECT<span class=\"token punctuation\">(</span>\n               <span class=\"token string\">'type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'FeatureCollection'</span><span class=\"token punctuation\">,</span>\n               <span class=\"token string\">'features'</span><span class=\"token punctuation\">,</span> JSON_AGG<span class=\"token punctuation\">(</span>st_asgeojson<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>::JSONB<span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">)</span> <span class=\"token keyword\">AS</span> feature_collection\n<span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">geometry</span><span class=\"token punctuation\">,</span> farm_id<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> area_square_meters <span class=\"token keyword\">FROM</span> field<span class=\"token punctuation\">)</span> f\n<span class=\"token keyword\">GROUP</span> <span class=\"token keyword\">BY</span> farm_id<span class=\"token punctuation\">;</span></code></pre></div>\n<p>This would only generate the Properties: <code class=\"language-text\">id</code>, <code class=\"language-text\">farm_id</code>, <code class=\"language-text\">area_square_meters</code></p>","excerpt":"Generating a Feature and Feature Collection form postgis is rather simple. If you convert a simple GEOMETRY with the  postgis will generate a GeoJSON \"geometry…","frontmatter":{"date":"27 April, 2023","path":"/notes/feature-collection-postgis","title":"Create a Feature Collection from Postgis Geometries using Postgis >= 3.0.0"},"timeToRead":1}},"pageContext":{}},"staticQueryHashes":["3649515864","63159454"],"slicesMap":{}}